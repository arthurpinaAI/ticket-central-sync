name: Ticket Central Sync (writeback dedupe + retry-safe)

on:
  workflow_dispatch:
    inputs:
      startFromNow:
        description: "Stamp sync flags now (skip history this run)"
        required: false
        default: "false"
  schedule:
    # 07:00 IST (01:30 UTC)
    - cron: "30 1 * * *"

concurrency:
  group: ticket-central-sync
  cancel-in-progress: false

jobs:
  sync:
    runs-on: ubuntu-latest
    timeout-minutes: 90
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run sync (retry-safe)
        env:
          GOOGLE_SERVICE_ACCOUNT_JSON: ${{ secrets.GOOGLE_SERVICE_ACCOUNT_JSON }}
          MASTER_SPREADSHEET_ID: ${{ secrets.MASTER_SPREADSHEET_ID }}
          MASTER_TICKETS_TAB: ${{ vars.MASTER_TICKETS_TAB || 'Tickets' }}
          MASTER_SOURCE_TAB: ${{ vars.MASTER_SOURCE_TAB || 'Source' }}
          TAIL_WINDOW_ROWS: "2000"
          THROTTLE_MS_PER_READ: "250"        # sleep 0.25s after each range GET
          SLEEP_BETWEEN_SOURCES_MS: "1000"   # sleep 1s after each source
          SLEEP_BETWEEN_FLOWS_MS: "3000"     # sleep 3s between ALL and LI passes
# Optional source sharding (split across multiple runs if needed)
          TOTAL_SHARDS: "1"                  # set to 2 or 3 to split sources
          SHARD_INDEX: "0"                   # 0..TOTAL_SHARDS-1; run different shards at different times
          PAGE_ROWS: "100000"
          BATCH_APPEND_ROWS: "500"
          BACKOFF_BASE_SEC: "2.0"
          BACKOFF_MAX_SEC: "20.0"
          START_FROM_NOW: ${{ github.event.inputs.startFromNow || 'false' }}
          SYNC_COL_ALL: "30"
          SYNC_COL_LI: "30"
        run: |
          for i in 1 2 3; do
            python sync.py && exit 0
            echo "Run failed (attempt $i). Retrying after 45s..."
            sleep 45
          done
          exit 1
